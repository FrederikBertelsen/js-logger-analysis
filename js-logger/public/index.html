<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User Interaction Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <script src="js/event-elements-injector.js"></script>

    <script src="js/logger-controls-injector.js"></script>
    <script src="js/page-links-injector.js"></script>
    <script src="js/session-id-manager.js"></script>
    <!-- <script src="js/event-tracker.js"></script> -->
    <script src="js/download-string.js"></script>

    <script>
        // Helper function to send events to the server
        const container = document.createElement('div');
        container.className = 'download-button';

        // Create HTML structure for controls
        container.innerHTML = `
        <div class="inline-group" style="display: flex; justify-content: center; align-items: center;">
            <button id="download-button">Download</button>
        </div>
        `;
        var times = []
        var startTime = performance.now()
        var endTime = performance.now()

        document.body.prepend(container);
        document.getElementById('download-button').addEventListener('click', () => {
            if (times.length >= 0) {
                downloadTextFile(times.join('\n'), 'download.txt');
                times = []
            }
        });
        // async function sendEvent(level = 'info', details = {}) {
        //     console.log('Sending', level, 'log:', details);
        //     startTime = performance.now()

        //     const payload = {
        //         sessionId: window.getSessionId(),
        //         time: new Date().toISOString(),
        //         level: level,
        //         ...details
        //     };

        //     await fetch('/api/event', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify(payload)
        //     })
        //         .catch(err => console.error('Error sending event:', err));
        //     endTime = performance.now();
        //     times.push(endTime - startTime)
        // }

        async function send100kLogs(bigLog = false) {
            if (window.running && window.running === true) {
                console.log("Already running!");
                return;
            }
            window.running = true;

            console.log(`Sending 100k ${bigLog ? "BIG" : "small"} logs`);

            // generate payload
            logText = "";
            if (bigLog) {
                for (var i = 0; i < 5000; i++) {
                    // Generate random character code in the printable ASCII range (32-126)
                    const randomCharCode = Math.floor(Math.random() * (126 - 32 + 1)) + 32;
                    logText += String.fromCharCode(randomCharCode);
                }
            } else {
                logText += "button clicked"
            }
            const payloadString = JSON.stringify({
                sessionId: window.getSessionId(),
                time: new Date().toISOString(),
                level: "info",
                text: logText
            });

            // 100K LOOP
            for (var i = 0; i < 100000; i++) {
                startTime = performance.now()

                await fetch('/api/event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payloadString
                })
                    .catch(err => console.error('Error sending event:', err));

                endTime = performance.now();
                times.push(endTime - startTime)
            }
        }
        // set listeners for button clicks
        document.getElementById('btn-click-loop').addEventListener('click', () => {
            send100kLogs(false);
        });
        document.getElementById('btn-click-loop-big').addEventListener('click', () => {
            send100kLogs(true);
        });
    </script>
</body>

</html>